import{r as _,S as P,y as L,j as e,R as d,a as D}from"./entry-index-Cq13IMyc.js";import{t as r}from"./chunk-index-CSMgxAiP.js";import{A as G,u as N}from"./chunk-AccountContext-Cg6rtKP_.js";import{u as S}from"./chunk-useTranslation-DT6f2-nl.js";import{c as U}from"./chunk-createLucideIcon-SgBSd_zz.js";import{e as q,t as z,v as V,r as H,p as f}from"./chunk-flex-D_qeScnl.js";import{e as T}from"./chunk-badge-C4fUOBFU.js";import{o as c}from"./chunk-button-BTrNb_zO.js";import{s as k,n as C,p as F,g as O,m as R,D as J}from"./chunk-dialog-ChtOFG_l.js";import{u as y}from"./chunk-text-field-BPsisRj1.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-require-react-element-DaU34sMa.js";import"./chunk-internal-BM6wX41l.js";const M=parseFloat(_.version)>=19||"",Q={loading:{type:"boolean",default:!0},...z,...q},$=_.forwardRef((s,a)=>{const{children:o,className:u,loading:i,...h}=V(s,Q,H);if(!i)return o;const m=_.isValidElement(o)?P:"span";return _.createElement(m,{ref:a,"aria-hidden":!0,className:L("rt-Skeleton",u),"data-inline-skeleton":_.isValidElement(o)?void 0:!0,tabIndex:-1,inert:M,...h},o)});$.displayName="Skeleton";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=[["path",{d:"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4",key:"tonef"}],["path",{d:"M9 18c-4.51 2-5-2-7-2",key:"9comsn"}]],A=U("github",B),ue=()=>e.jsx(G,{children:e.jsx(W,{})}),W=()=>{const{t:s}=S(),{account:a,loading:o,error:u,refresh:i}=N(),[h,m]=d.useState(!1),[l,x]=d.useState(!1);if(o)return e.jsx(D,{});if(u)return e.jsx("div",{children:u.message});function v(t){t.preventDefault(),m(!0),fetch("/api/admin/update/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuid:a==null?void 0:a.uuid,username:t.currentTarget.username.value})}).then(n=>{if(!n.ok)throw new Error("Failed to update username");return n.json()}).then(()=>{r.success(s("common.updated_successfully"))}).catch(n=>{r.error(n.message)}).finally(()=>{m(!1)})}function g(t){t.preventDefault();const n=t.currentTarget,p=n.password.value,E=n.password_repeat.value;if(!p||!E){r.error(s("account.password_empty_error"));return}if(p!==E){r.error(s("account.password_mismatch_error"));return}if(p.length<8){r.error(s("account.password_too_short_error"));return}if(!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(p)){r.error(s("account.password_strength_error"));return}x(!0),fetch("/api/admin/update/user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuid:a==null?void 0:a.uuid,password:p})}).then(async b=>{if(!b.ok){const I=await b.json();throw new Error(I.message||"Failed to update password")}return b.json()}).then(()=>{r.success(s("common.updated_successfully")),setTimeout(()=>{window.location.href="/"},2e3)}).catch(b=>{r.error(b.message)}).finally(()=>{x(!1)})}function j(){var t;return((t=a==null?void 0:a.sso_id)==null?void 0:t.startsWith("github_"))||!1}const w=async()=>{try{if(j()){const t=await fetch("/api/admin/oauth2/unbind",{method:"POST"});if(t.ok)r.success(s("account_settings.unbind_github_success")),i();else{const n=await t.json();r.error(`${s("account_settings.unbind_github_failed")}: ${n.message||s("未知错误")}`)}}else window.location.href="/api/admin/oauth2/bind"}catch(t){console.error("处理GitHub认证失败:",t),r.error(s("account_settings.github_auth_failed"))}finally{}};return e.jsxs(f,{gap:"4",direction:"row",className:"p-4",wrap:"wrap",children:[e.jsxs(f,{gap:"2",direction:"column",className:"w-full",children:[e.jsx("label",{className:"text-2xl font-bold",children:s("account.title")}),e.jsx("label",{className:"text-lg",children:s("account.greeting",{username:a==null?void 0:a.username})}),e.jsxs("form",{className:"flex gap-2 flex-col",onSubmit:v,children:[e.jsx("label",{className:"font-bold",htmlFor:"username",children:s("account.change_username_title")}),e.jsx(y,{className:"max-w-128",id:"username",name:"username",defaultValue:a==null?void 0:a.username}),e.jsx("div",{children:e.jsx(c,{disabled:h,type:"submit",children:s("account.change_username_button")})})]}),e.jsxs("form",{onSubmit:g,className:"flex flex-col gap-2",children:[e.jsx("label",{className:"font-bold",htmlFor:"old_password",children:s("account.change_password_title")}),e.jsx("label",{htmlFor:"password",children:s("account.new_password")}),e.jsx(y,{className:"max-w-128",id:"password",name:"password",type:"password"}),e.jsx("label",{htmlFor:"password_repeat",children:s("account.new_password_repeat")}),e.jsx(y,{className:"max-w-128",id:"password_repeat",name:"password_repeat",type:"password"}),e.jsx("div",{children:e.jsx(c,{disabled:l,type:"submit",children:s("account.change_password_button")})})]})]}),e.jsxs(f,{direction:"column",className:"md:basis-5/12 gap-2",children:[e.jsx("label",{className:"font-bold text-2xl",children:"2FA"}),a!=null&&a["2fa_enabled"]?e.jsx(K,{}):e.jsx(Z,{}),e.jsx("label",{className:"font-bold text-2xl mt-2",children:s("settings.sso.title")}),e.jsxs("div",{className:"mb-8 flex flex-col gap-4",children:[e.jsxs("label",{className:"text-xl font-semibold flex items-center gap-2",children:[e.jsx(A,{className:"size-5"}),s("account_settings.github_account")]}),e.jsx("div",{className:"p-4 bg-[var(--accent-2)] rounded-lg",children:e.jsx("p",{children:j()?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{color:"green",children:s("account_settings.github_bound")}),"GitHub ID: ",a==null?void 0:a.sso_id.replace("github_","")]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{color:"gray",children:s("account_settings.github_unbound")}),s("account_settings.github_not_bound")]})})}),e.jsx("div",{children:j()?e.jsxs(k,{children:[e.jsx(C,{children:e.jsx(c,{children:s("account_settings.unbind_github")})}),e.jsxs(F,{children:[e.jsx(O,{children:s("account_settings.confirm_unbind")}),e.jsx(R,{children:s("account_settings.unbind_github_warning")}),e.jsxs(f,{gap:"2",justify:"end",className:"mt-4",children:[e.jsx(J,{children:e.jsx(c,{variant:"soft",children:s("account_settings.cancel")})}),e.jsx(c,{color:"red",onClick:w,children:s("account_settings.confirm_unbind")})]})]})]}):e.jsxs(c,{onClick:w,children:[e.jsx(A,{className:"size-4"}),s("account_settings.bind_github")]})})]}),e.jsx("div",{children:e.jsx(c,{onClick:()=>{window.open("/api/admin/download/backup","_blank")},children:s("account_settings.download_backup")})})]})]})},Z=()=>{const{t:s}=S(),{refresh:a}=N(),[o,u]=d.useState(!1),[i,h]=d.useState(!1),[m,l]=d.useState(!0),[x,v]=d.useState(null),[g,j]=d.useState("");d.useEffect(()=>{i&&(l(!0),fetch("/api/admin/2fa/generate").then(t=>{if(!t.ok)throw new Error(s("account.qr_fetch_error"));return t.blob()}).then(t=>{const n=URL.createObjectURL(t);v(n)}).catch(t=>r.error(t.message)).finally(()=>l(!1)))},[i]);const w=t=>{if(t.preventDefault(),!g){r.error(s("account.otp_empty_error"));return}u(!0),fetch(`/api/admin/2fa/enable?code=${encodeURIComponent(g)}`,{method:"POST"}).then(async n=>{if(!n.ok){const p=await n.json();throw new Error(p.message||`Failed to enable 2FA (${n.status})`)}return n.json()}).then(()=>{r.success(s("common.updated_successfully")),h(!1),a()}).catch(n=>r.error(n.message)).finally(()=>u(!1))};return e.jsxs(f,{direction:"column",gap:"2",children:[e.jsx("label",{className:"text-lg font-bold",children:s("account.2fa_disabled")}),e.jsxs(k,{open:i,onOpenChange:h,children:[e.jsx(C,{children:e.jsx("div",{children:e.jsx(c,{className:"w-full",children:s("account.enable_2fa")})})}),e.jsxs(F,{children:[e.jsx(O,{children:s("account.enable_2fa")}),e.jsxs(f,{direction:"column",gap:"2",children:[e.jsx("label",{children:s("account.2fa_qr_code_hint")}),e.jsx("div",{className:"flex justify-center",children:m?e.jsx($,{width:"200px",height:"200px"}):e.jsx("img",{src:x,alt:"2FA QR Code",width:200,height:200})}),e.jsx("label",{children:s("account.2fa_otp_input_prompt")}),e.jsxs("form",{className:"flex flex-col gap-2",onSubmit:w,children:[e.jsx(y,{type:"number",name:"code",placeholder:"000000",value:g,onChange:t=>j(t.target.value)}),e.jsx(c,{disabled:o,type:"submit",children:s("account.enable_2fa")})]})]})]})]})]})},K=()=>{const{t:s}=S(),[a,o]=d.useState(!1),[u,i]=d.useState(!1),{refresh:h}=N(),m=()=>{i(!0),fetch("/api/admin/2fa/disable",{method:"POST"}).then(async l=>{if(!l.ok){const x=await l.json();throw new Error(x.message||"Failed to disable 2FA")}return l.json()}).then(()=>{r.success(s("common.updated_successfully")),o(!1),h()}).catch(l=>{r.error(l.message)}).finally(()=>{i(!1)})};return e.jsxs(f,{direction:"column",gap:"2",children:[e.jsx("label",{children:s("account.2fa_enabled")}),e.jsx("div",{children:e.jsxs(k,{open:a,onOpenChange:o,children:[e.jsx(C,{children:e.jsx(c,{className:"ml-2",color:"red",children:s("account.disable_2fa")})}),e.jsxs(F,{children:[e.jsx(O,{children:s("account.disable_2fa")}),e.jsx(R,{children:s("account.disable_2fa_confirmation")}),e.jsxs(f,{gap:"2",justify:"end",className:"mt-4",children:[e.jsx(c,{variant:"soft",onClick:()=>o(!1),children:s("common.cancel")}),e.jsx(c,{disabled:u,color:"red",onClick:m,children:s("common.confirm")})]})]})]})})]})};export{ue as default};
