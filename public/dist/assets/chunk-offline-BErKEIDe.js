import{r as j,j as e,k as re,P as ae,d as z,f as D,x as se,R as p,a as ce}from"./entry-index-Cq13IMyc.js";import{u as ie}from"./chunk-require-react-element-DaU34sMa.js";import{u as de}from"./chunk-index-CMdh1AKP.js";import{c as le}from"./chunk-index-l6qGRyk6.js";import{c as ue}from"./chunk-utils-bRKmu4jq.js";import{c as fe}from"./chunk-createLucideIcon-SgBSd_zz.js";import{T as he,a as me,b as F,c as y,d as pe,e as S}from"./chunk-table-BS5X1aPI.js";import{N as xe,u as A,P as be}from"./chunk-NodeDetailsContext-Bc0mLyEG.js";import{t as E}from"./chunk-index-CSMgxAiP.js";import{u as N}from"./chunk-useTranslation-DT6f2-nl.js";import{S as ge}from"./chunk-search-CaXYtT1h.js";import{p as P}from"./chunk-flex-D_qeScnl.js";import{u as H,c as je}from"./chunk-text-field-BPsisRj1.js";import{s as q,n as $,p as G,g as J,D as ve}from"./chunk-dialog-ChtOFG_l.js";import{o as O}from"./chunk-button-BTrNb_zO.js";import{e as Ce}from"./chunk-badge-C4fUOBFU.js";import{i as ke}from"./chunk-switch-CttJqP-B.js";import{o as _e}from"./chunk-icon-button-8RHoNX6f.js";import"./chunk-react-vendor-Csw2ODfV.js";import"./chunk-internal-BM6wX41l.js";/**
 * @license lucide-react v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],ye=fe("check",we);var Se=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],T=Se.reduce((n,r)=>{const c=le(`Primitive.${r}`),d=j.forwardRef((s,t)=>{const{asChild:f,...o}=s,a=f?c:r;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(a,{...o,ref:t})});return d.displayName=`Primitive.${r}`,{...n,[r]:d}},{}),R="Checkbox",[Ee,tt]=re(R),[Pe,I]=Ee(R);function Ne(n){const{__scopeCheckbox:r,checked:c,children:d,defaultChecked:s,disabled:t,form:f,name:o,onCheckedChange:a,required:u,value:h="on",internal_do_not_use_render:l}=n,[m,v]=ie({prop:c,defaultProp:s??!1,onChange:a,caller:R}),[b,C]=j.useState(null),[_,x]=j.useState(null),i=j.useRef(!1),w=b?!!f||!!b.closest("form"):!0,g={checked:m,disabled:t,setChecked:v,control:b,setControl:C,name:o,form:f,value:h,hasConsumerStoppedPropagationRef:i,required:u,defaultChecked:k(s)?!1:s,isFormControl:w,bubbleInput:_,setBubbleInput:x};return e.jsx(Pe,{scope:r,...g,children:Re(l)?l(g):d})}var K="CheckboxTrigger",U=j.forwardRef(({__scopeCheckbox:n,onKeyDown:r,onClick:c,...d},s)=>{const{control:t,value:f,disabled:o,checked:a,required:u,setControl:h,setChecked:l,hasConsumerStoppedPropagationRef:m,isFormControl:v,bubbleInput:b}=I(K,n),C=z(s,h),_=j.useRef(a);return j.useEffect(()=>{const x=t==null?void 0:t.form;if(x){const i=()=>l(_.current);return x.addEventListener("reset",i),()=>x.removeEventListener("reset",i)}},[t,l]),e.jsx(T.button,{type:"button",role:"checkbox","aria-checked":k(a)?"mixed":a,"aria-required":u,"data-state":Z(a),"data-disabled":o?"":void 0,disabled:o,value:f,...d,ref:C,onKeyDown:D(r,x=>{x.key==="Enter"&&x.preventDefault()}),onClick:D(c,x=>{l(i=>k(i)?!0:!i),b&&v&&(m.current=x.isPropagationStopped(),m.current||x.stopPropagation())})})});U.displayName=K;var X=j.forwardRef((n,r)=>{const{__scopeCheckbox:c,name:d,checked:s,defaultChecked:t,required:f,disabled:o,value:a,onCheckedChange:u,form:h,...l}=n;return e.jsx(Ne,{__scopeCheckbox:c,checked:s,defaultChecked:t,disabled:o,required:f,onCheckedChange:u,name:d,form:h,value:a,internal_do_not_use_render:({isFormControl:m})=>e.jsxs(e.Fragment,{children:[e.jsx(U,{...l,ref:r,__scopeCheckbox:c}),m&&e.jsx(W,{__scopeCheckbox:c})]})})});X.displayName=R;var V="CheckboxIndicator",Y=j.forwardRef((n,r)=>{const{__scopeCheckbox:c,forceMount:d,...s}=n,t=I(V,c);return e.jsx(ae,{present:d||k(t.checked)||t.checked===!0,children:e.jsx(T.span,{"data-state":Z(t.checked),"data-disabled":t.disabled?"":void 0,...s,ref:r,style:{pointerEvents:"none",...n.style}})})});Y.displayName=V;var Q="CheckboxBubbleInput",W=j.forwardRef(({__scopeCheckbox:n,...r},c)=>{const{control:d,hasConsumerStoppedPropagationRef:s,checked:t,defaultChecked:f,required:o,disabled:a,name:u,value:h,form:l,bubbleInput:m,setBubbleInput:v}=I(Q,n),b=z(c,v),C=de(t),_=se(d);j.useEffect(()=>{const i=m;if(!i)return;const w=window.HTMLInputElement.prototype,B=Object.getOwnPropertyDescriptor(w,"checked").set,ne=!s.current;if(C!==t&&B){const oe=new Event("click",{bubbles:ne});i.indeterminate=k(t),B.call(i,k(t)?!1:t),i.dispatchEvent(oe)}},[m,C,t,s]);const x=j.useRef(k(t)?!1:t);return e.jsx(T.input,{type:"checkbox","aria-hidden":!0,defaultChecked:f??x.current,required:o,disabled:a,name:u,value:h,form:l,...r,tabIndex:-1,ref:b,style:{...r.style,..._,position:"absolute",pointerEvents:"none",opacity:0,margin:0,transform:"translateX(-100%)"}})});W.displayName=Q;function Re(n){return typeof n=="function"}function k(n){return n==="indeterminate"}function Z(n){return k(n)?"indeterminate":n?"checked":"unchecked"}function M({className:n,...r}){return e.jsx(X,{"data-slot":"checkbox",className:ue("peer border-[var(--accent-6)] bg-[var(--accent-1)] data-[state=checked]:bg-[var(--accent-8)] data-[state=checked]:text-[var(--accent-12)] data-[state=checked]:border-[var(--accent-9)] focus-visible:border-[var(--accent-10)] focus-visible:ring-[var(--accent-7)]/50 aria-invalid:ring-red-500/20 dark:aria-invalid:ring-red-400/40 aria-invalid:border-red-500 size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",n),...r,children:e.jsx(Y,{"data-slot":"checkbox-indicator",className:"flex items-center justify-center text-current transition-none",children:e.jsx(ye,{className:"size-3.5"})})})}const ee=p.createContext(void 0),Oe=({children:n})=>{const[r,c]=p.useState([]),[d,s]=p.useState(!1),t=p.useRef(!0),[f,o]=p.useState(null),a=async()=>{t.current&&s(!0);try{const u=await fetch("/api/admin/notification/offline");if(!u.ok)throw new Error("Failed to fetch offline notifications");const h=await u.json();c(h.data||[])}catch(u){console.error("Error fetching offline notifications:",u),o(u instanceof Error?u:new Error(String(u)))}finally{t.current&&(s(!1),t.current=!1)}};return p.useEffect(()=>{a()},[]),e.jsx(ee.Provider,{value:{offlineNotification:r,refresh:a,loading:d,error:f},children:n})},L=()=>{const n=p.useContext(ee);if(!n)throw new Error("useOfflineNotification must be used within a OfflineNotificationProvider");return n},nt=()=>e.jsx(Oe,{children:e.jsx(xe,{children:e.jsx(Te,{})})}),te=({initialValues:n,onSubmit:r,loading:c,onCancel:d})=>{const{t:s}=N(),[t,f]=p.useState(n.enable),[o,a]=p.useState(n.grace_period);return e.jsxs("form",{onSubmit:u=>{u.preventDefault(),r({enable:t,cooldown:3e3,grace_period:o})},className:"flex flex-col gap-2",children:[e.jsx("label",{htmlFor:"status",children:s("common.status")}),e.jsx(ke,{id:"status",name:"status",checked:t,onCheckedChange:f}),e.jsx("label",{htmlFor:"grace_period",children:s("notification.offline.grace_period")}),e.jsx(H,{type:"number",min:0,value:o,onChange:u=>a(Number(u.target.value)),id:"grace_period",name:"grace_period"}),e.jsxs(P,{gap:"2",justify:"end",className:"mt-4",children:[d&&e.jsx(ve,{children:e.jsx(O,{variant:"soft",color:"gray",type:"button",onClick:d,children:s("common.cancel")})}),e.jsx(O,{variant:"solid",type:"submit",disabled:c,children:s("common.save")})]})]})},Te=()=>{const[n,r]=p.useState(""),[c,d]=p.useState([]),{loading:s,error:t,offlineNotification:f,refresh:o}=L(),{isLoading:a,error:u}=A(),{t:h}=N(),[l,m]=p.useState(!1),[v,b]=p.useState(!1),[C,_]=p.useState({enable:!0,cooldown:1800,grace_period:300}),x=i=>{m(!0);const w=c.map(g=>({client:g,enable:i.enable,cooldown:i.cooldown,grace_period:i.grace_period}));fetch("/api/admin/notification/offline/edit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}).then(g=>(g.ok?E.success(h("common.updated_successfully")):E.error("Failed to update offline notifications: "+g.statusText),g.json())).then(()=>{m(!1),b(!1),o()}).catch(g=>{console.error("Error updating offline notifications:",g),E.error(h("common.error",{message:g.message})),m(!1)})};return s||a?e.jsx(ce,{text:"(o゜▽゜)o☆"}):t||u?e.jsxs("div",{children:["Error: ",(t==null?void 0:t.message)||u]}):e.jsxs("div",{className:"flex flex-col gap-4 md:p-4 p-1",children:[e.jsxs(P,{justify:"between",align:"center",wrap:"wrap",children:[e.jsx("label",{className:"text-2xl font-semibold",children:h("notification.offline.full_title","离线通知设置")}),e.jsx(H,{type:"text",className:"max-w-64",placeholder:h("common.search"),value:n,onChange:i=>r(i.target.value),children:e.jsx(je,{children:e.jsx(ge,{size:16})})})]}),e.jsx(Ie,{search:n,selected:c,onSelectionChange:d}),e.jsx("label",{className:"text-sm text-muted-foreground",children:h("common.selected",{count:c.length})}),e.jsx(P,{gap:"2",align:"center",children:e.jsxs(q,{open:v,onOpenChange:b,children:[e.jsx($,{children:e.jsx(O,{variant:"soft",onClick:()=>{const i=f.find(w=>w.client===c[0]);_({enable:(i==null?void 0:i.enable)??!0,cooldown:(i==null?void 0:i.cooldown)??1800,grace_period:(i==null?void 0:i.grace_period)??300})},disabled:l||c.length===0,children:h("notification.offline.batch_edit")})}),e.jsxs(G,{children:[e.jsx(J,{children:h("notification.offline.batch_edit")}),e.jsx(te,{initialValues:C,loading:l,onSubmit:x,onCancel:()=>b(!1)})]})]})}),e.jsx("label",{className:"text-sm text-muted-foreground",children:e.jsx("span",{dangerouslySetInnerHTML:{__html:h("notification.offline.tips")}})})]})},Ie=({search:n,selected:r,onSelectionChange:c})=>{const{offlineNotification:d}=L(),{nodeDetail:s}=A(),{t}=N(),f=[...s].sort((o,a)=>o.weight-a.weight).filter(o=>o.name.toLowerCase().includes(n.toLowerCase()));return e.jsx("div",{className:"rounded-lg overflow-hidden",children:e.jsxs(he,{children:[e.jsx(me,{children:e.jsxs(F,{children:[e.jsx(y,{className:"w-6",children:e.jsx(M,{checked:r.length===f.length?!0:r.length>0?"indeterminate":!1,onCheckedChange:o=>c(o?f.map(a=>a.uuid):[])})}),e.jsx(y,{children:t("common.server")}),e.jsx(y,{children:t("common.status")}),e.jsx(y,{children:t("notification.offline.grace_period")}),e.jsx(y,{children:t("notification.offline.last_notified")}),e.jsx(y,{children:t("common.action")})]})}),e.jsx(pe,{children:f.map(o=>{var a,u,h;return e.jsxs(F,{children:[e.jsx(S,{children:e.jsx(M,{checked:r.includes(o.uuid),onCheckedChange:l=>{c(l?[...r,o.uuid]:r.filter(m=>m!==o.uuid))}})}),e.jsx(S,{children:o.name}),e.jsx(S,{children:e.jsx(Ce,{color:(a=d.find(l=>l.client===o.uuid))!=null&&a.enable?"green":"red",children:(u=d.find(l=>l.client===o.uuid))!=null&&u.enable?t("common.enabled"):t("common.disabled")})}),e.jsxs(S,{children:[((h=d.find(l=>l.client===o.uuid))==null?void 0:h.grace_period)||300,t("nodeCard.time_second")]}),e.jsx(S,{children:(()=>{var v;const l=(v=d.find(b=>b.client===o.uuid))==null?void 0:v.last_notified;if(!l)return"-";const m=new Date(l);return m.getFullYear()<3?t("notification.offline.never_triggered"):m.toLocaleString()})()}),e.jsx(S,{children:e.jsx(Le,{offlineNotifications:d.find(l=>l.client===o.uuid)})})]},o.uuid)})})]})})},Le=({offlineNotifications:n})=>{const{t:r}=N(),{refresh:c}=L(),[d,s]=p.useState(!1),[t,f]=p.useState(!1);return e.jsx(P,{gap:"2",align:"center",children:e.jsxs(q,{open:d,onOpenChange:s,children:[e.jsx($,{children:e.jsx(_e,{variant:"ghost",children:e.jsx(be,{size:16})})}),e.jsxs(G,{children:[e.jsx(J,{children:r("common.edit")}),e.jsx(te,{initialValues:{enable:(n==null?void 0:n.enable)??!1,cooldown:(n==null?void 0:n.cooldown)??1800,grace_period:(n==null?void 0:n.grace_period)??300},loading:t,onSubmit:o=>{f(!0),fetch("/api/admin/notification/offline/edit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify([{client:n==null?void 0:n.client,...o}])}).then(a=>(a.ok||E.error("Failed to save offline notification settings: "+a.statusText),E.success(r("common.updated_successfully")),a.json())).then(()=>{s(!1),c(),f(!1)}).catch(a=>{console.error("Error saving offline notification settings:",a),E.error(r("common.error",{message:a.message}))})},onCancel:()=>s(!1)})]})]})})};export{nt as default};
